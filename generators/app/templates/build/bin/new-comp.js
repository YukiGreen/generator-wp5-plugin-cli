"use strict";

console.log();
process.on("exit", () => {
  console.log();
});

if (!process.argv[2]) {
  console.error("[组件名]必填 - Please enter new component name");
  process.exit(1);
}

/**
 * [camelCaseToHyphen 将驼峰命名转换为连字符]
 * @param  {[string]} str [驼峰命名的字符串]
 * @return {[string]}     [连字符的字符串]
 */
function camelCaseToHyphen(str) {
  return str.replace(/([a-z])([A-Z])/g, "$1-$2").toLowerCase();
}

// var Components = require('../../components.json');componentsFile

const path = require("path");
const fs = require("fs");
const fileSave = require("file-save");
const uppercamelcase = require("uppercamelcase");
const componentname = process.argv[2];
const prefix = process.argv[3] || '';
const chineseName = process.argv[4] || componentname;
const ComponentName = uppercamelcase(componentname);
const PackagePath = path.resolve(__dirname, "../../packages", componentname);
const Files = [
  {
    filename: "index.js",
    content: `import ${ComponentName} from './src/index';

/* istanbul ignore next */
${ComponentName}.install = function(Vue) {
  Vue.component(${ComponentName}.name, ${ComponentName});
};

export default ${ComponentName};`
  },
  {
    filename: "src/index.vue",
    content: `<template>
  <div class="${prefix}${prefix ? '-' : ''}${camelCaseToHyphen(componentname)}"></div>
</template>

<script lang="ts">
import { Component, Vue } from 'vue-property-decorator';

@Component
export default class ${ComponentName} extends Vue {

}
</script>`
  },
  {
    filename: "index.less",
    content: ""
  },
  {
    filename: path.join("../../docs/docs", `${componentname}.md`),
    content: `## ${ComponentName} ${chineseName}`
  },
  {
    filename: path.join(
      "../../examples/template",
      `${componentname}/index.vue`
    ),
    content: `<template>
  <div style="width: 100%; height: 100%"><${camelCaseToHyphen(componentname)} /></div>
</template>`
  },
  {
    filename: path.join("../../test/unit/specs", `${componentname}.spec.js`),
    content: `import { createTest, destroyVM } from '../util';
import ${ComponentName} from 'packages/${componentname}';

describe('${ComponentName}', () => {
  let vm;
  afterEach(() => {
    destroyVM(vm);
  });

  it('create', () => {
    vm = createTest(${ComponentName}, true);
    expect(vm.$el).to.exist;
  });
});
`
  },

  {
    filename: path.join(`../../src/i18ns/en/`, `${componentname}.ts`),
    content: `export default {}`
  },
  {
    filename: path.join(`../../src/i18ns/zh-CN/`, `${componentname}.ts`),
    content: `export default {}`
  },
  {
    filename: path.join(`../../src/services/`, `${componentname}/API.ts`),
    content: `import ComponentAPI from '../ComponentAPI.json';
const API = {
};
export default API;`
  },
  {
    filename: path.join(`../../src/services/`, `${componentname}/index.ts`),
    content: `import API from "./API";
import HttpClientHelper from "../../utils/httpClientHelper";
class ${ComponentName}Service {
}

export default new ${ComponentName}Service();`
  }
];

// 添加到 components.json
const componentsFile = require("../../components.json");
if (componentsFile[componentname]) {
  console.error(`${componentname} 已存在.`);
  process.exit(1);
}
componentsFile[componentname] = `./packages/${componentname}/index.js`;
fileSave(path.join(__dirname, "../../components.json"))
  .write(JSON.stringify(componentsFile, null, "  "), "utf8")
  .end("\n");

// 添加到 exposeComponents.json
// const exposesFile = require("../../exposeComponents.json");
// exposesFile[`./${componentname}`] = `./packages/${componentname}/src/index.vue`;
// fileSave(path.join(__dirname, "../../exposeComponents.json"))
//   .write(JSON.stringify(exposesFile, null, "  "), "utf8")
//   .end("\n");

// 创建 package
Files.forEach(file => {
  fileSave(path.join(PackagePath, file.filename))
    .write(file.content, "utf8")
    .end("\n");
});

// 添加到 nav.config.json
const navConfigFile = require("../../docs/nav.config.json");

Object.keys(navConfigFile).forEach(lang => {
  let children = navConfigFile[lang][2].children;
  children.push({
    path: `/${componentname}`,
    name:
      lang === "zh-CN" && componentname !== chineseName
        ? `${ComponentName} ${chineseName}`
        : ComponentName
  });
});

fileSave(path.join(__dirname, "../../docs/nav.config.json"))
  .write(JSON.stringify(navConfigFile, null, "  "), "utf8")
  .end("\n");

console.log("DONE!");

// 导入services/index.ts
var render = require("json-templater/string");
var endOfLine = require("os").EOL;
var OUTPUT_PATH = path.join(__dirname, "../../src/services/index.ts");
var IMPORT_TEMPLATE =
  "export { default as {{packageUpper}}Service } from './{{package}}';";
var MAIN_TEMPLATE = `/* Automatically generated by './build/bin/build-service.js' */
{{include}}
`;

delete componentsFile.font;
function fileExists(filePath) {
  try {
    return fs.statSync(filePath).isFile();
  } catch (err) {
    return false;
  }
}
var ComponentNames = Object.keys(componentsFile);

var includeComponentTemplate = [];

ComponentNames.forEach(name => {
  var filePath = path.resolve(
    __dirname,
    "../../src/services/" + name + "/index.ts"
  );
  if (fileExists(filePath)) {
    includeComponentTemplate.push(
      render(IMPORT_TEMPLATE, {
        packageUpper: uppercamelcase(name),
        package: name
      })
    );
  }
});

var template = render(MAIN_TEMPLATE, {
  include: includeComponentTemplate.join(endOfLine)
});

fs.writeFileSync(OUTPUT_PATH, template);
/**
new.js脚本主要做了下面几件事：

把你新建的组件添加到 components.json
创建 package
添加 index.less
创建 国际化文件
创建 Service文件
添加到 nav.config.json
重写 service/index.ts
重写 generators\app\templates\exposeComponents.json
*/
